<!DOCTYPE html>
<html lang="fr"
      data-th-replace="~{layout::layout(contenu=~{::main},titre=~{::title})}"
      xmlns:th="http://www.thymeleaf.org">
<head>
    <title>D√©tail de l'ench√®re</title>
</head>
<body>
<main class="detail-container">
    <!-- Messages d'alerte -->
    <div th:if="${success}" class="alert alert--success" th:text="${success}"></div>
    <div th:if="${error}" class="alert alert--danger" th:text="${error}"></div>
    
    <!-- Photo de l'article -->
    <div class="detail-photo">
        <img th:if="${article.photo != null and article.photo != ''}" 
             th:src="@{'/images/articles/' + ${article.no_article}}"
             th:alt="${article.nom_article}"
             class="detail-photo__image"/>
        <img th:unless="${article.photo != null and article.photo != ''}" 
             src="/images/default.webp" 
             alt="Image par d√©faut" 
             class="detail-photo__image detail-photo__image--default"/>
    </div>
    
    <div class="detail-table">
        <div class="detail-table__row">
            <div class="detail-table__cell detail-table__label">Article :</div>
            <div class="detail-table__cell detail-table__value" th:text="${article.nom_article}"></div>
            <div class="detail-table__cell detail-table__label">Mise √† prix :</div>
            <div class="detail-table__cell detail-table__value" th:text="${article.prix_initial} + ' point(s)' "></div>
        </div>
        <div class="detail-table__row">
            <div class="detail-table__cell detail-table__label">Cat√©gorie :</div>
            <div class="detail-table__cell detail-table__value" th:text="${article.categorie.libelle}"></div>
            <div class="detail-table__cell detail-table__label">Meilleure offre :</div>
            <div class="detail-table__cell detail-table__value" th:text="${meilleureOffre} + ' point(s)'"></div>
        </div>
        <div class="detail-table__row">
            <div class="detail-table__cell detail-table__label">Description :</div>
            <div class="detail-table__cell detail-table__value" th:text="${article.description}" colspan="3"></div>
            <div class="detail-table__cell detail-table__label">Fin de l'ench√®re :</div>
            <div class="detail-table__cell detail-table__value" th:text="${#dates.format(article.date_fin_enchere, 'dd/MM/yyyy HH:mm')}"></div>
            <div class="detail-table__cell detail-table__label">Statut :</div>
            <div class="detail-table__cell detail-table__value">
                <span th:if="${enchereTerminee}" class="encheres-status--finished">üî¥ Termin√©e</span>
                <span th:unless="${enchereTerminee}">
                    <div id="countdown" th:data-date-fin="${dateFinFormatted}" class="detail-countdown">
                        Chargement...
                    </div>
                </span>
            </div>
        </div>
    </div>
    
    <div class="detail-bottom">
        <div class="retrait">
            <span class="label">Retrait :</span>
            <span class="value" th:text="${article.adresse_retrait.rue + ' ' + article.adresse_retrait.code_postal + ' ' + article.adresse_retrait.ville}"></span>
        </div>
        <div class="vendeur">
            <span class="label">Vendeur :</span>
            <a data-th-href="@{/profil(pseudo=${article.vendeur.pseudo})}" class="value" th:text="${article.vendeur.pseudo}"></a>
        </div>
        
        <!-- Affichage du gagnant si l'ench√®re est termin√©e -->
        <div th:if="${enchereTerminee}" class="detail-enchere">
            <div class="enchere-terminee">
                <h3 class="enchere-terminee-titre">üèÜ Ench√®re termin√©e</h3>
                
                <div th:if="${gagnant != null}" class="gagnant-info">
                    <div class="detail-winner">
                        <h4 class="detail-winner__title">üéâ Gagnant de l'ench√®re</h4>
                        <p class="detail-winner__pseudo"><strong th:text="${gagnant.pseudo}">Pseudo du gagnant</strong></p>
                        <p class="detail-winner__price">Prix final : <strong th:text="${prixFinal} + ' points'">0 points</strong></p>
                    </div>
                </div>
                
                <div th:unless="${gagnant != null}" class="detail-no-winner">
                    <div class="alert alert--info">
                        <h4 class="detail-no-winner__title">üì≠ Aucune ench√®re</h4>
                        <p>Cet article n'a re√ßu aucune ench√®re et n'a pas √©t√© vendu.</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Formulaire d'ench√®re (seulement si l'ench√®re n'est pas termin√©e) -->
        <div th:if="${!enchereTerminee and peutEncherir}" class="detail-enchere">
            <div class="detail-credit">
                <span class="detail-credit__label">üí∞ Votre cr√©dit :</span>
                <span class="detail-credit__value" th:text="${creditUtilisateur} + ' points'">0 points</span>
            </div>
            
            <form th:action="@{/enchere/soumettre}" method="post" class="detail-enchere__form">
                <input type="hidden" name="no_article" th:value="${article.no_article}">
                
                <div class="detail-enchere__input-group">
                    <label for="montant_propose" class="detail-enchere__label">Votre ench√®re :</label>
                    <input type="number" 
                           id="montant_propose" 
                           name="montant_propose" 
                           th:min="${montantMinimum}" 
                           th:max="${creditUtilisateur}"
                           th:placeholder="'Minimum : ' + ${montantMinimum} + ' points'"
                           required
                           class="detail-enchere__input">
                    <span class="detail-enchere__info">Minimum : <span th:text="${montantMinimum}"></span> points | Maximum : <span th:text="${creditUtilisateur}"></span> points</span>
                </div>
                
                <div class="form-buttons">
                    <button type="submit" class="btn btn--primary" th:disabled="${creditUtilisateur < montantMinimum}" name="action" value="encherir">
                        <span th:if="${creditUtilisateur >= montantMinimum}">Ench√©rir</span>
                        <span th:unless="${creditUtilisateur >= montantMinimum}">Cr√©dit insuffisant</span>
                    </button>
                </div>
            </form>
        </div>
        
        <!-- Message si l'utilisateur ne peut pas ench√©rir (et ench√®re pas termin√©e) -->
        <div th:if="${!enchereTerminee and !peutEncherir}" class="detail-enchere">
            <div th:if="${#authorization.expression('isAuthenticated()')}" class="alert alert--info">
                Vous ne pouvez pas ench√©rir sur votre propre article.
            </div>
            <div th:unless="${#authorization.expression('isAuthenticated()')}" class="alert alert--warning">
                Vous devez √™tre connect√© pour ench√©rir.
                <a th:href="@{/connexion}" class="btn btn--secondary">Se connecter</a>
            </div>
        </div>

        <div class="form-buttons">
            <form th:if="${enchereTerminee and gagnant != null and #authentication.name == gagnant.pseudo}" method="post" th:action="@{/enchere/soumettre}">
                <input type="hidden" name="no_article" value="${article.noArticle}">
                <button type="submit" name="action" value="confirmer_retrait">Retrait effectu√©</button>
            </form>
            <a th:href="@{/enchere}" class="btn btn--secondary">Retour √† la liste</a>
        </div>
    </div>

</main>


</body>
</html>