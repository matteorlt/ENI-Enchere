<!DOCTYPE html>
<html lang="fr"
      data-th-replace="~{layout::layout(contenu=~{::main},titre=~{::title})}"
      xmlns:th="http://www.thymeleaf.org">
<head>
    <title>D√©tail de l'ench√®re</title>
    <link rel="stylesheet" th:href="@{/css/details.css}"/>
</head>
<body>
<main class="detail-container">
    <!-- Messages d'alerte -->
    <div th:if="${success}" class="alert alert-success" th:text="${success}"></div>
    <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>
    
    <!-- Photo de l'article -->
    <div class="article-photo-container">
        <img th:if="${article.photo != null and article.photo != ''}" 
             th:src="@{'/images/articles/' + ${article.no_article}}"
             th:alt="${article.nom_article}"
             class="article-photo-large"
            style="max-width: 300px"/>
        <img th:unless="${article.photo != null and article.photo != ''}" 
             src="/images/default.webp" 
             alt="Image par d√©faut" 
             class="article-photo-large default-image"
             style="max-width: 300px"/>
    </div>
    
    <div class="detail-table">
        <div class="row">
            <div class="cell label">Article :</div>
            <div class="cell value" th:text="${article.nom_article}"></div>
            <div class="cell label">Mise √† prix :</div>
            <div class="cell value" th:text="${article.prix_initial} + ' point(s)' "></div>
        </div>
        <div class="row">
            <div class="cell label">Cat√©gorie :</div>
            <div class="cell value" th:text="${article.categorie.libelle}"></div>
            <div class="cell label">Meilleure offre :</div>
            <div class="cell value" th:text="${meilleureOffre} + ' point(s)'"></div>
        </div>
        <div class="row">
            <div class="cell label">Description :</div>
            <div class="cell value" th:text="${article.description}" colspan="3"></div>
            <div class="cell label">Fin de l'ench√®re :</div>
            <div class="cell value" th:text="${#dates.format(article.date_fin_enchere, 'dd/MM/yyyy HH:mm')}"></div>
            <div class="cell label">Statut :</div>
            <div class="cell value">
                <span th:if="${enchereTerminee}" class="statut-termine-detail">üî¥ Termin√©e</span>
                <span th:unless="${enchereTerminee}">
                    <div id="countdown" th:data-date-fin="${dateFinFormatted}">
                        Chargement...
                    </div>
                </span>
            </div>
        </div>
    </div>
    
    <div class="detail-bottom">
        <div class="retrait">
            <span class="label">Retrait :</span>
            <span class="value" th:text="${article.adresse_retrait.rue + ' ' + article.adresse_retrait.code_postal + ' ' + article.adresse_retrait.ville}"></span>
        </div>
        <div class="vendeur">
            <span class="label">Vendeur :</span>
            <a data-th-href="@{/profil(pseudo=${article.vendeur.pseudo})}" class="value" th:text="${article.vendeur.pseudo}"></a>
        </div>
        
        <!-- Affichage du gagnant si l'ench√®re est termin√©e -->
        <div th:if="${enchereTerminee}" class="enchere-section">
            <div class="enchere-terminee">
                <h3 class="enchere-terminee-titre">üèÜ Ench√®re termin√©e</h3>
                
                <div th:if="${gagnant != null}" class="gagnant-info">
                    <div class="gagnant-card">
                        <h4>üéâ Gagnant de l'ench√®re</h4>
                        <p class="gagnant-pseudo"><strong th:text="${gagnant.pseudo}">Pseudo du gagnant</strong></p>
                        <p class="prix-final">Prix final : <strong th:text="${prixFinal} + ' points'">0 points</strong></p>
                    </div>
                </div>
                
                <div th:unless="${gagnant != null}" class="pas-de-gagnant">
                    <div class="alert alert-info">
                        <h4>üì≠ Aucune ench√®re</h4>
                        <p>Cet article n'a re√ßu aucune ench√®re et n'a pas √©t√© vendu.</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Formulaire d'ench√®re (seulement si l'ench√®re n'est pas termin√©e) -->
        <div th:if="${!enchereTerminee and peutEncherir}" class="enchere-section">
            <div class="credit-info">
                <span class="credit-label">üí∞ Votre cr√©dit :</span>
                <span class="credit-value" th:text="${creditUtilisateur} + ' points'">0 points</span>
            </div>
            
            <form th:action="@{/enchere/soumettre}" method="post" class="enchere-form">
                <input type="hidden" name="no_article" th:value="${article.no_article}">
                
                <div class="enchere-input">
                    <label for="montant_propose">Votre ench√®re :</label>
                    <input type="number" 
                           id="montant_propose" 
                           name="montant_propose" 
                           th:min="${montantMinimum}" 
                           th:max="${creditUtilisateur}"
                           th:placeholder="'Minimum : ' + ${montantMinimum} + ' points'"
                           required>
                    <span class="montant-info">Minimum : <span th:text="${montantMinimum}"></span> points | Maximum : <span th:text="${creditUtilisateur}"></span> points</span>
                </div>
                
                <div class="button-detail">
                    <button type="submit" class="btn btn-primary" th:disabled="${creditUtilisateur < montantMinimum}">
                        <span th:if="${creditUtilisateur >= montantMinimum}">Ench√©rir</span>
                        <span th:unless="${creditUtilisateur >= montantMinimum}">Cr√©dit insuffisant</span>
                    </button>
                </div>
            </form>
        </div>
        
        <!-- Message si l'utilisateur ne peut pas ench√©rir (et ench√®re pas termin√©e) -->
        <div th:if="${!enchereTerminee and !peutEncherir}" class="enchere-section">
            <div th:if="${#authorization.expression('isAuthenticated()')}" class="alert alert-info">
                Vous ne pouvez pas ench√©rir sur votre propre article.
            </div>
            <div th:unless="${#authorization.expression('isAuthenticated()')}" class="alert alert-warning">
                Vous devez √™tre connect√© pour ench√©rir.
                <a th:href="@{/connexion}" class="btn btn-secondary">Se connecter</a>
            </div>
        </div>
        
        <div class="button-detail">
            <a th:href="@{/enchere}" class="btn btn-secondary">Retour √† la liste</a>
        </div>
    </div>

</main>

<style>
.article-photo-container {
    text-align: center;
    margin-bottom: 20px;
}

.article-photo-large {
    max-width: 400px;
    max-height: 300px;
    border: 2px solid #ddd;
    border-radius: 8px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.article-photo-large.default-image {
    opacity: 0.7;
}

.article-image {
    max-width: 200px;
    max-height: 150px;
    border: 1px solid #ddd;
    border-radius: 4px;
    object-fit: cover;
}

.article-image.default-image {
    opacity: 0.6;
}

.credit-info {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    padding: 10px;
    margin-bottom: 15px;
    text-align: center;
}

.credit-label {
    font-weight: bold;
    color: #495057;
}

.credit-value {
    font-weight: bold;
    color: #28a745;
    font-size: 1.1em;
}

.montant-info {
    font-size: 0.9em;
    color: #6c757d;
    margin-top: 5px;
}

.btn:disabled {
    background-color: #6c757d !important;
    border-color: #6c757d !important;
    cursor: not-allowed;
    opacity: 0.6;
}

.enchere-terminee {
    text-align: center;
    padding: 20px;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 12px;
    border: 2px solid #dee2e6;
}

.enchere-terminee-titre {
    color: #495057;
    margin-bottom: 20px;
    font-size: 1.5em;
}

.gagnant-card {
    background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
    border: 2px solid #28a745;
    border-radius: 10px;
    padding: 20px;
    margin: 15px 0;
    box-shadow: 0 4px 8px rgba(40, 167, 69, 0.2);
}

.gagnant-card h4 {
    color: #155724;
    margin-bottom: 15px;
    font-size: 1.3em;
}

.gagnant-pseudo {
    font-size: 1.2em;
    color: #155724;
    margin: 10px 0;
}

.prix-final {
    font-size: 1.1em;
    color: #155724;
    margin: 10px 0;
}

.pas-de-gagnant .alert {
    background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
    border: 2px solid #ffc107;
    color: #856404;
}

.pas-de-gagnant h4 {
    color: #856404;
    margin-bottom: 10px;
}

.statut-termine-detail {
    font-weight: bold;
    color: #dc3545;
    background-color: #f8d7da;
    padding: 4px 8px;
    border-radius: 4px;
    border: 1px solid #f5c6cb;
}
</style>
</body>
</html>